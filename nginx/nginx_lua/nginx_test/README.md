# CDN多源站智能选择

## 目的
```
当我们访问的源站有多个节点时，为了解决CDN节点在访问源站的时候能够根据当时的网络情况进行自动负载以及自动上下线，使得用户通过我们CDN后访问源站会有最好的用户体验。
```

## 需要解决的问题
1. CDN能够自动下线故障源站节点，并在一段时间后上线，做到自动化上下线。
2. CDN能够根据网络下载速度，自动上调或者下降某个源站节点的权重，将更多的访问转移到网络更好的源站节点上。
3. CDN能够根据连续源站访问错误，急速衰减这个源站节点的权重，并将访问转移到更优的源站节点上

## 方案
### 源站节点故障处理
```
若源站节点连续四次故障（服务器故障），将暂时下线故障源站节点，并在五分钟后恢复上线，若恢复上线后连续四次访问故障，再次下线
```
### 源站网络速度变化
```
会根据源站节点的网络访问速度，自动化的调整节点的权重，每次访问的增量为 math.log10(1 + math.log(1 + rate * rate))，速度越好的节点增量越快，权重就会变得越高
```

### 错误产生对权重的影响
```
服务节点每产生一次错误，将会对自身权重降低10%，为了避免网络好的节点权重高了后，请求量上去了，但是服务器压力上升，导致错误率上升，而产生服务质量下降的情况。
```

## 结论
1. CDN能够根据网络情况，自动对网络较好的节点分配更多的网络访问，使得同样次数的网络访问，总用时更少
2. CDN能够自动上下线错误节点，使得几乎不会对用户产生任何感知，而切换了网络访问，为用户提供良好的用户体验（错误率更低）
3. 当某个节点由于服务压力而产生错误时，权重能迅速衰减，使得系统趋于平衡，能让用户系统更稳定。
