# 中断和异常
```
中断和异常相关的学习
```

## 定义
```
中断（interrupt）通常被定义为一个事件，该事件改变处理器执行的指令顺序。
```

## 分类
```
中断通常分为同步中断和异步中断:
    同步中断: 当指令执行时，由CPU控制单元产生的，之所以称为同步，因为只有在一条指令终止执行后CPU才会发出中断。
    异步中断: 其他硬件设备依照CPU时钟信号随机产生的。

Intel微处理器手册中把同步中断称为异常（exception），异步中断称为中断（interrupt）
    * 中断
        1. 可屏蔽中断(maskable interrupt)
            I/O设备发出的所有中断请求（IRQ）都产生可屏蔽中断。可屏蔽中断可以处于屏蔽、非屏蔽状态；一个屏蔽的中断只要还是屏蔽的，控制单元就忽略它。
        2. 非可屏蔽中断(nonmaskable interrupt)
            只有几个危急事件（如硬件故障）才引起非屏蔽中断。非屏蔽中断总是由CPU辨认。
    * 异常
        1. 处理器探测异常(processor-detected exception)
            当CPU执行指令时探测到的一个反常条件所产生的异常，可以分为3组，取决于CPU控制单元产生异常时保存在内核态堆栈eip寄存器中的值。
            a. 故障(fault)
                通常可以纠正，一旦纠正，程序可以在不失连贯性的情况下重新开始。保存在eip中的值是引起故障的指令地址。如缺页异常处理。
            b. 陷阱(trap)
                陷阱指令执行后立即报告，内核把控制权返回给程序后就可以继续它的执行而不失连贯性。保存在eip中的值是一个随后要执行的指令地址。主要用途是调试程序，中断信号的作用就是同志调试程序一条特殊指令已被执行（如到了一个程序内的断点）。
            c. 异常终止(abort)
                发生一个严重的错误；控制单元出了问题，不能在eip寄存器中保存引起异常的指令所在的确切位置。异常终止用于报告严重的错误，如硬件故障或系统表中无效的值或不一致的值。由控制单元发送的这个中断信号是紧急信号，用来把控制权切换到相应的异常终止处理程序，这个异常终止处理程序除了强制受影响的进程终止外，没有别的选择。
        2. 编程异常(programmed exception)
            在编程者发出请求时发生。控制单元把编成异常作为陷阱来处理。编程异常通常也叫软中断（software interrupt），主要两用途：执行系统调用以及给调试程序通报一个特定的事件。
```

## 软中断及tasklet
```
出现在内核代码中的术语"软中断(softirq)"常常表示可延迟函数的所有种类。另一种被广泛使用的术语是"中断上下文"：表示内核当前正在执行一个中断处理程序或一个可延迟的函数。
tasklet是在软中断之上实现的
软中断（即便是同一种类型的软中断）可以并发的运行在多个CPU上。因此软中断是可重入函数且必须明确地使用自旋锁保护其数据结构。
tasklet不必担心这些问题，内核对tasklet的执行由严格控制，同类型的tasklet总是被串行的执行。因此tasklet函数不必是可重入的。
```
### 软中断
```
linux/interrupt.h
enum {
    HI_SOFTIRQ=0, // 处理高优先级的tasklet
    TIMER_SOFTIRQ, // 时钟中断相关的tasklet
    NET_TX_SOFTIRQ,
    NET_RX_SOFTIRQ,
    BLOCK_SOFTIRQ,
    IRQ_POLL_SOFTIRQ,
    TASKLET_SOFTIRQ, // 处理常规tasklet
    SCHED_SOFTIRQ,
    HRTIMER_SOFTIRQ,
    RCU_SOFTIRQ,

    NR_SOFTIRQS
};
```

## REF
    深入理解Linux内核
    [Linux kernel的中断子系统]("http://www.wowotech.net/irq_subsystem/soft-irq.html")
